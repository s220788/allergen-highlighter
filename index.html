<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' https://accounts.google.com https://www.gstatic.com 'unsafe-inline' 'unsafe-eval' blob:;
    style-src 'self' https://accounts.google.com https://fonts.googleapis.com 'unsafe-inline';
    connect-src 'self' https://docs.googleapis.com https://www.googleapis.com https://accounts.google.com https://content-docs.googleapis.com;
    frame-src 'self' https://accounts.google.com https://content-docs.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    img-src 'self' https://www.gstatic.com data:;
  ">
  <title>Allergen Highlighter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    textarea, input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    textarea {
      height: 150px;
      resize: vertical;
    }
    #output {
      padding: 15px;
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    .allergen-ingredient {
      font-weight: bold;
      background-color: #fff3cd;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .allergen-emoji {
      margin-right: 3px;
    }
    .allergen-legend {
      margin-bottom: 15px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
    }
    #docLink {
      margin-top: 15px;
      padding: 12px;
      background: #e8f5e9;
      border: 1px solid #c8e6c9;
      border-radius: 4px;
      display: none;
    }
    #authSection {
      margin-bottom: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    #signoutButton {
      padding: 8px 16px;
      margin-right: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      background-color: #f44336;
      color: white;
    }
    #authStatus {
      color: #666;
      font-style: italic;
    }
    #checkAllergensBtn {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    #checkAllergensBtn:hover {
      background-color: #45a049;
    }
    #checkAllergensBtn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .hidden {
      display: none !important;
    }
    h2, h3 {
      color: #2c3e50;
    }
    a {
      color: #2c3e50;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .g_id_signin {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h2>Allergen Highlighter</h2>
  
  <div id="authSection">
    <div id="g_id_onload"
         data-client_id="937805701155-qfln1a6mgph0rm37hvg00mv4i80aeil6.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
    <button id="signoutButton" class="hidden">Sign Out</button>
    <span id="authStatus">Not signed in</span>
  </div>
  
  <p>Enter product information:</p>
  <input type="text" id="productName" placeholder="Product Name">
  <textarea id="ingredientsInput" placeholder="Paste ingredients list here..."></textarea>
  <button id="checkAllergensBtn" disabled>Check Allergens</button>
  
  <h3>Results:</h3>
  <div id="output"></div>
  <div id="docLink" class="hidden"></div>

  <script src="https://accounts.google.com/gsi/client"></script>
  <script>
    // Configuration with your credentials
    const CLIENT_ID = '937805701155-qfln1a6mgph0rm37hvg00mv4i80aeil6.apps.googleusercontent.com';
    const DISCOVERY_DOC = 'https://docs.googleapis.com/$discovery/rest?version=v1';
    const SCOPES = 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file';

    let googleDocId = '';
    let docLink = '';
    let isSignedIn = false;
    let tokenClient;
    let gapiInitialized = false;

    // Allergen data
    const allergenMap = {
      "CELERY": ["celery", "celery stalks", "celeriac", "celery seeds", "celery salt", "celery powder", "celery extract", "dehydrated celery"],
      "CEREALS CONTAINING GLUTEN": ["wheat", "spelt", "durum", "semolina", "kamut", "farro", "einkorn", "emmer", "rye", "barley", "malt", "malt extract", "malt vinegar", "oats", "triticale", "flour", "couscous", "bulgur", "breadcrumbs"],
      "CRUSTACEANS": ["prawn", "prawns", "shrimp", "crab", "lobster", "crayfish", "langoustine", "scampi", "krill", "shrimp paste", "crustacean extract"],
      "EGGS": ["egg", "eggs", "egg yolk", "egg white", "whole egg", "powdered egg", "pasteurised egg", "albumin", "ovalbumin", "lecithin (from egg)"],
      "FISH": ["fish", "cod", "salmon", "tuna", "haddock", "anchovy", "anchovies", "surimi", "fish paste", "fish sauce", "fish stock", "omega-3 oils", "isinglass"],
      "LUPIN": ["lupin", "lupin flour", "lupin seeds", "toasted lupin"],
      "MILK": ["milk", "cow milk", "goat milk", "sheep milk", "cream", "butter", "cheese", "yogurt", "whey", "casein", "lactose", "milk solids", "skimmed milk powder", "ghee"],
      "MOLLUSCS": ["mussel", "mussels", "clam", "clams", "oyster", "oysters", "scallop", "scallops", "cockle", "cockles", "whelk", "whelks", "snail", "snails", "squid", "octopus", "cuttlefish"],
      "MUSTARD": ["mustard", "mustard seeds", "mustard powder", "mustard flour", "prepared mustard", "mustard oil", "mustard extract"],
      "NUTS": ["nut", "nuts", "almond", "almonds", "brazil nut", "brazil nuts", "cashew", "cashews", "hazelnut", "hazelnuts", "macadamia", "pecan", "pecans", "pistachio", "pistachios", "walnut", "walnuts", "nut oils", "marzipan", "praline"],
      "PEANUTS": ["peanut", "peanuts", "groundnut", "groundnuts", "peanut oil", "peanut butter", "peanut flour", "peanut extract"],
      "SESAME SEEDS": ["sesame", "sesame seed", "sesame seeds", "sesame oil", "tahini", "sesame flour", "sesame extract"],
      "SOYA": ["soy", "soya", "soybean", "soybeans", "soya milk", "tofu", "tempeh", "edamame", "soy sauce", "tamari", "miso", "soya flour", "soy protein", "soy lecithin"],
      "SULPHUR DIOXIDE/SULPHITES": ["sulphur dioxide", "sodium metabisulphite", "potassium metabisulphite", "sodium sulphite", "potassium sulphite"]
    };

    const allergenEmojis = {
      "CELERY": "üåø",
      "CEREALS CONTAINING GLUTEN": "üåæ",
      "CRUSTACEANS": "ü¶ê",
      "EGGS": "ü•ö",
      "FISH": "üêü",
      "LUPIN": "üå±",
      "MILK": "ü•õ",
      "MOLLUSCS": "ü¶ë",
      "MUSTARD": "üü°",
      "NUTS": "üå∞",
      "PEANUTS": "ü•ú",
      "SESAME SEEDS": "‚ö´",
      "SOYA": "üü§",
      "SULPHUR DIOXIDE/SULPHITES": "‚ö™"
    };

    function handleCredentialResponse(response) {
      if (response.credential) {
        isSignedIn = true;
        document.getElementById('authStatus').textContent = 'Signed in';
        document.getElementById('signoutButton').classList.remove('hidden');
        document.querySelector('.g_id_signin').style.display = 'none';
        updateButtonState();
        
        // Initialize Google API client
        initializeGapiClient();
      }
    }

    function initializeGapiClient() {
      gapi.load('client', () => {
        gapi.client.init({
          discoveryDocs: [DISCOVERY_DOC]
        }).then(() => {
          gapiInitialized = true;
          console.log('Google API client initialized');
          initTokenClient();
        }).catch(error => {
          console.error('Error initializing Google API client:', error);
        });
      });
    }

    function signOut() {
      google.accounts.id.disableAutoSelect();
      google.accounts.id.revoke(CLIENT_ID, done => {
        console.log('Consent revoked');
      });
      isSignedIn = false;
      gapiInitialized = false;
      document.getElementById('authStatus').textContent = 'Not signed in';
      document.getElementById('signoutButton').classList.add('hidden');
      document.querySelector('.g_id_signin').style.display = 'block';
      updateButtonState();
    }

    function updateButtonState() {
      const checkBtn = document.getElementById('checkAllergensBtn');
      const productName = document.getElementById('productName').value.trim();
      const ingredients = document.getElementById('ingredientsInput').value.trim();
      
      checkBtn.disabled = !(isSignedIn && productName && ingredients);
    }

    function initTokenClient() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            highlightAllergens();
          }
        },
        error_callback: (error) => {
          console.error('Google OAuth error:', error);
          alert('Error during Google sign-in: ' + error.message);
        }
      });
    }

    function createGoogleDoc() {
      const productName = document.getElementById('productName').value.trim();
      const timestamp = new Date().toLocaleString();
      const docTitle = `Allergen Report - ${productName || 'Untitled'} - ${timestamp}`;

      return gapi.client.docs.documents.create({
        title: docTitle
      }).then(function(response) {
        googleDocId = response.result.documentId;
        docLink = `https://docs.google.com/document/d/${googleDocId}/edit`;
        
        const docLinkElement = document.getElementById('docLink');
        docLinkElement.innerHTML = `<a href="${docLink}" target="_blank">View Google Doc</a>`;
        docLinkElement.classList.remove('hidden');
        
        return googleDocId;
      }).catch(function(error) {
        console.error("Error creating document:", error);
        throw error;
      });
    }

    function appendToGoogleDoc(content) {
      return gapi.client.docs.documents.batchUpdate({
        documentId: googleDocId,
        requests: [{
          insertText: {
            location: { index: 1 },
            text: content + '\n\n'
          }
        }]
      }).catch(function(error) {
        console.error("Error appending to document:", error);
        throw error;
      });
    }

    function highlightAllergens() {
      if (!isSignedIn) {
        tokenClient.requestAccessToken();
        return;
      }

      const productName = document.getElementById('productName').value;
      if (!productName) {
        alert('Please enter a product name');
        return;
      }

      const input = document.getElementById('ingredientsInput').value;
      if (!input) {
        alert('Please enter ingredients');
        return;
      }

      let output = input;
      const foundAllergens = new Set();
      const matches = [];

      Object.entries(allergenMap).forEach(([allergen, terms]) => {
        terms.forEach(term => {
          const regex = new RegExp(`\\b${term}(es|s)?\\b`, 'gi');
          let match;
          while ((match = regex.exec(input)) !== null) {
            matches.push({
              start: match.index,
              end: match.index + match[0].length,
              allergen: allergen,
              text: match[0]
            });
            foundAllergens.add(allergen);
          }
        });
      });

      matches.sort((a, b) => b.start - a.start);

      matches.forEach(match => {
        const emoji = allergenEmojis[match.allergen] || '‚ö†Ô∏è';
        output = output.substring(0, match.start) + 
                 emoji + 
                 '<span class="allergen-ingredient">' + 
                 match.text + 
                 '</span>' + 
                 output.substring(match.end);
      });

      let legend = '';
      if (foundAllergens.size > 0) {
        legend = '<div class="allergen-legend"><strong>Allergens present:</strong><br>';
        legend += Array.from(foundAllergens).sort().map(allergen => {
          return `${allergenEmojis[allergen]} ${allergen}`;
        }).join(', ');
        legend += '</div>';
      }

      document.getElementById('output').innerHTML = legend + output;

      const docContent = `Product: ${productName}\n\n` +
                         `Ingredients:\n${input}\n\n` +
                         `Allergens found:\n${Array.from(foundAllergens).sort().join(', ')}\n\n` +
                         `Highlighted ingredients:\n${output.replace(/<[^>]*>/g, '')}`;

      const docPromise = googleDocId 
        ? Promise.resolve(googleDocId)
        : createGoogleDoc();

      docPromise.then(() => {
        return appendToGoogleDoc(docContent);
      }).catch(error => {
        console.error("Error saving to Google Docs", error);
        alert("Error saving to Google Docs: " + error.message);
      });
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', function() {
      // Load Google API client
      const gapiScript = document.createElement('script');
      gapiScript.src = 'https://apis.google.com/js/api.js';
      gapiScript.async = true;
      gapiScript.defer = true;
      gapiScript.onload = function() {
        console.log('Google API client loaded');
      };
      document.body.appendChild(gapiScript);

      // Set up sign out button
      document.getElementById('signoutButton').onclick = signOut;

      // Set up check allergens button
      document.getElementById('checkAllergensBtn').onclick = function() {
        if (!isSignedIn) {
          tokenClient.requestAccessToken();
        } else {
          highlightAllergens();
        }
      };

      // Add event listeners for input changes
      document.getElementById('productName').addEventListener('input', updateButtonState);
      document.getElementById('ingredientsInput').addEventListener('input', updateButtonState);
      
      // Initialize token client
      initTokenClient();
    });

    window.handleCredentialResponse = handleCredentialResponse;
  </script>
</body>
</html>
